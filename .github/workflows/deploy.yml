name: CI/CD Zero Downtime Deploy

on:
  push:
    branches: [ "develop" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/wind-fall-server:latest .

      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/wind-fall-server:latest

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DB_JDBC_URL: ${{ secrets.DB_JDBC_URL }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REST_API_KAKAO: ${{ secrets.REST_API_KAKAO }}
          REDIRECT_URI_KAKAO: ${{ secrets.REDIRECT_URI_KAKAO }}
          CLIENT_ID_NAVER: ${{ secrets.CLIENT_ID_NAVER }}
          REDIRECT_URI_NAVER: ${{ secrets.REDIRECT_URI_NAVER }}
          CLIENT_ID_GOOGLE: ${{ secrets.CLIENT_ID_GOOGLE }}
          REDIRECT_URI_GOOGLE: ${{ secrets.REDIRECT_URI_GOOGLE }}
          SECRET_PATTERN: ${{ secrets.SECRET_PATTERN }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
          S3_BASE_URL: ${{ secrets.S3_BASE_URL }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          envs: >
            DOCKER_USERNAME, DOCKER_PASSWORD,
            DB_JDBC_URL, DB_USER, DB_PASSWORD,
            REDIS_HOST, REST_API_KAKAO, REDIRECT_URI_KAKAO,
            CLIENT_ID_NAVER, REDIRECT_URI_NAVER,
            CLIENT_ID_GOOGLE, REDIRECT_URI_GOOGLE,
            SECRET_PATTERN, CORS_ALLOWED_ORIGINS,
            S3_ACCESS_KEY, S3_SECRET_KEY, BUCKET_NAME, S3_BASE_URL
          script: |
            echo "$DOCKER_PASSWORD" | sudo docker login -u "$DOCKER_USERNAME" --password-stdin
            
            CURRENT_PORT=$(sed -n 's/.*:\([0-9]*\);/\1/p' /etc/nginx/conf.d/service-url.inc)
            echo "Current port: $CURRENT_PORT"
            
            if [ "$CURRENT_PORT" = "8080" ]; then
              TARGET_PORT=8081
              TARGET_NAME="wind-fall-green"
              STOP_NAME="wind-fall-blue"
            else
              TARGET_PORT=8080
              TARGET_NAME="wind-fall-blue"
              STOP_NAME="wind-fall-green"
            fi
            
            echo "Target port: $TARGET_PORT"
            
            sudo docker pull "$DOCKER_USERNAME"/wind-fall-server:latest
            
            sudo docker rm -f "$TARGET_NAME" 2>/dev/null || true
            
            echo "Starting new container..."
            sudo docker run -d \
              --name "$TARGET_NAME" \
              -p "$TARGET_PORT":8080 \
              --network windfall-net \
              -e TZ=Asia/Seoul \
              -e SPRING_DATASOURCE_URL="$DB_JDBC_URL" \
              -e SPRING_DATASOURCE_USERNAME="$DB_USER" \
              -e SPRING_DATASOURCE_PASSWORD="$DB_PASSWORD" \
              -e SPRING_DATA_REDIS_HOST="$REDIS_HOST" \
              -e REST_API_KAKAO="$REST_API_KAKAO" \
              -e REDIRECT_URI_KAKAO="$REDIRECT_URI_KAKAO" \
              -e CLIENT_ID_NAVER="$CLIENT_ID_NAVER" \
              -e REDIRECT_URI_NAVER="$REDIRECT_URI_NAVER" \
              -e CLIENT_ID_GOOGLE="$CLIENT_ID_GOOGLE" \
              -e REDIRECT_URI_GOOGLE="$REDIRECT_URI_GOOGLE" \
              -e SECRET_PATTERN="$SECRET_PATTERN" \
              -e CORS_ALLOWED_ORIGINS="$CORS_ALLOWED_ORIGINS" \
              -e S3_ACCESS_KEY="$S3_ACCESS_KEY" \
              -e S3_SECRET_KEY="$S3_SECRET_KEY" \
              -e BUCKET_NAME="$BUCKET_NAME" \
              -e S3_BASE_URL="$S3_BASE_URL" \
              "$DOCKER_USERNAME"/wind-fall-server:latest
            
            echo "Starting Health Check..."
            for i in {1..12}; do
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:"$TARGET_PORT"/ || true)
            
              if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
                echo "Health Check Passed! (Status: $RESPONSE)"
                break
              fi
            
              if [ $i -eq 12 ]; then
                echo "Health Check Failed. (Status: $RESPONSE)"
                echo "⬇️⬇️⬇️ ERROR LOGS ⬇️⬇️⬇️"
                sudo docker logs --tail 50 "$TARGET_NAME"
                echo "⬆️⬆️⬆️ ERROR LOGS ⬆️⬆️⬆️"
                sudo docker stop "$TARGET_NAME"
                sudo docker rm "$TARGET_NAME"
                exit 1
              fi
              echo "Waiting... ($i/12) - Current Status: $RESPONSE"
              sleep 10
            done
            
            echo "set \$service_url http://127.0.0.1:$TARGET_PORT;" | sudo tee /etc/nginx/conf.d/service-url.inc
            sudo nginx -s reload
            
            sudo docker stop "$STOP_NAME" 2>/dev/null || true
            sudo docker rm "$STOP_NAME" 2>/dev/null || true
            sudo docker image prune -f