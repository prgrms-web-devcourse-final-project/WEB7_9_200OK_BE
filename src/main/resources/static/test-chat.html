<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Windfall Chat WS Test</title>

  <!-- SockJS + StompJS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    input, button { padding: 8px; margin: 4px; }
    .row { margin: 8px 0; }
    pre {
      background: #111;
      color: #0f0;
      padding: 16px;
      height: 520px;
      overflow: auto;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
<h2>STOMP Chat Test</h2>

<div class="row">
  <label>chatRoomId: </label>
  <input id="roomId" value="1" />
  <label>JWT (ÏÑ†ÌÉù): </label>
  <input id="token" style="width: 420px" placeholder="Bearer ÏóÜÏù¥ ÌÜ†ÌÅ∞Îßå ÎÑ£Ïñ¥ÎèÑ Îê®" />
  <button onclick="connect()">Connect</button>
  <button onclick="disconnect()">Disconnect</button>
</div>

<div class="row">
  <label>TEXT: </label>
  <input id="text" style="width: 520px" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•" />
  <button onclick="sendText()">Send Text</button>
  <button onclick="markRead()">Mark As Read</button>
</div>

<div class="row">
  <label>IMAGE URLÎì§(ÏΩ§Îßà): </label>
  <input id="imageUrls" style="width: 520px" placeholder="https://... , https://..." />
  <button onclick="sendImage()">Send Image Msg</button>
</div>

<h3>Logs</h3>
<pre id="log"></pre>

<script>
  let stompClient = null;
  let connectedRoomId = null;

  function log(msg) {
    const el = document.getElementById("log");
    el.textContent += msg + "\n";
    el.scrollTop = el.scrollHeight;
    console.log(msg);
  }

  function connect() {
    const roomId = document.getElementById("roomId").value.trim();
    const token = document.getElementById("token").value.trim();

    if (!roomId) {
      alert("chatRoomIdÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
      return;
    }

    const socket = new SockJS("/ws-stomp");
    stompClient = Stomp.over(socket);

    stompClient.debug = (str) => log("[stomp] " + str);

    const headers = {};
    if (token) headers["Authorization"] = token.startsWith("Bearer ") ? token : ("Bearer " + token);

    stompClient.connect(headers, (frame) => {
      connectedRoomId = roomId;
      log("‚úÖ CONNECTED: " + frame);

      // 1) Ï±ÑÌåÖÎ∞© ÌÜ†ÌîΩ Íµ¨ÎèÖ (Ìï¥Îãπ Î∞©Ïóê Î©îÏãúÏßÄ Ïò§Î©¥ ÏàòÏã†)
      stompClient.subscribe(`/topic/chat.rooms.${roomId}`, (message) => {
        log("üì© [ROOM TOPIC] " + message.body);
      });

      // 2) ÎÇ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ ÌÅê Íµ¨ÎèÖ (convertAndSendToUserÎ°ú Ïò§Îäî Ïù¥Î≤§Ìä∏)
      stompClient.subscribe(`/user/queue/chat.rooms`, (message) => {
        log("üßæ [MY ROOMS QUEUE] " + message.body);
      });

      stompClient.subscribe(`/user/queue/errors`, (message) => {
        log("üö® [WS ERROR] " + message.body);
      });

      stompClient.subscribe(`/topic/chat.read.${roomId}`, (message) => {
        log("üëÅÔ∏è [READ EVENT] " + message.body);
      });

      log("‚úÖ SUBSCRIBED to room + my queue");
    }, (err) => {
      log("‚ùå CONNECT ERROR: " + JSON.stringify(err));
    });
  }

  function disconnect() {
    if (stompClient) stompClient.disconnect(() => log("üëã DISCONNECTED"));
    stompClient = null;
    connectedRoomId = null;
  }

  function sendText() {
    if (!stompClient || !connectedRoomId) return alert("Î®ºÏ†Ä Connect ÌïòÏÑ∏Ïöî");
    const text = document.getElementById("text").value;

    const payload = {
      chatRoomId: Number(connectedRoomId),
      messageType: "TEXT",
      content: text,
      imageUrls: []
    };

    stompClient.send("/app/chat.send", {}, JSON.stringify(payload));
    log("‚û°Ô∏è SEND TEXT: " + JSON.stringify(payload));
  }

  function sendImage() {
    if (!stompClient || !connectedRoomId) return alert("Î®ºÏ†Ä Connect ÌïòÏÑ∏Ïöî");
    const raw = document.getElementById("imageUrls").value.trim();
    const urls = raw ? raw.split(",").map(s => s.trim()).filter(Boolean) : [];

    const payload = {
      chatRoomId: Number(connectedRoomId),
      messageType: "IMAGE",
      content: null,
      imageUrls: urls
    };

    stompClient.send("/app/chat.send", {}, JSON.stringify(payload));
    log("‚û°Ô∏è SEND IMAGE MSG: " + JSON.stringify(payload));
  }

  function markRead() {
    if (!stompClient || !connectedRoomId) return alert("Î®ºÏ†Ä Connect ÌïòÏÑ∏Ïöî");

    const payload = { chatRoomId: Number(connectedRoomId) };
    stompClient.send("/app/chat.read", {}, JSON.stringify(payload));
    log("üëÄ MARK READ: " + JSON.stringify(payload));
  }
</script>
</body>
</html>
