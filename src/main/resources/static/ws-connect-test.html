<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Windfall WS CONNECT Error Test</title>

  <!-- SockJS + StompJS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 20px auto; }
    input, button, select { padding: 8px; margin: 4px; }
    .row { margin: 8px 0; }
    pre {
      background: #111;
      color: #0f0;
      padding: 16px;
      height: 560px;
      overflow: auto;
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .hint { color: #444; font-size: 13px; margin-top: 4px; }
    .badge { display:inline-block; padding: 2px 6px; border-radius: 6px; background:#eee; font-size: 12px;}
  </style>
</head>
<body>
<h2>WS CONNECT Error Test <span class="badge">SockJS + StompJS</span></h2>

<div class="row">
  <label>Endpoint: </label>
  <select id="endpoint">
    <option value="/ws-stomp">/ws-stomp (SECURED)</option>
    <option value="/ws-stomp-public">/ws-stomp-public (PUBLIC)</option>
  </select>

  <label>JWT (ì„ íƒ): </label>
  <input id="token" style="width: 520px" placeholder="Bearer ì—†ì´ í† í°ë§Œ ë„£ì–´ë„ ë¨" />

  <button onclick="connect()">Connect</button>
  <button onclick="disconnect()">Disconnect</button>
  <button onclick="clearLog()">Clear</button>

  <div class="hint">
    âœ… ëª©í‘œ: CONNECT ë‹¨ê³„ì—ì„œ ì„œë²„ê°€ STOMP ERROR(JSON)ë¥¼ ë‚´ë ¤ì£¼ëŠ”ì§€ í™•ì¸<br/>
    - SECURED(/ws-stomp): í† í° ì—†ìŒ â†’ <b>WS_TOKEN_MISSING</b><br/>
    - ë§Œë£Œ í† í° â†’ <b>WS_TOKEN_EXPIRED</b> / ë¬´íš¨ í† í° â†’ <b>WS_TOKEN_INVALID</b><br/>
    - PUBLIC(/ws-stomp-public): í† í° ì—†ì´ë„ ì—°ê²° OK (ë‹¨, í† í°ì„ â€œë³´ë‚´ë©´â€ ê²€ì¦í•˜ë‹¤ê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
  </div>
</div>

<hr/>

<div class="row">
  <label>Connect Test Presets:</label>
  <button onclick="setToken('')">í† í° ë¹„ìš°ê¸°</button>
  <button onclick="setToken('abc.def.ghi')">ë¬´íš¨ í† í°(ê°€ì§œ)</button>
</div>

<div class="row">
  <label>After CONNECT (ì˜µì…˜)</label>
  <input id="roomId" value="1" style="width: 80px" />
  <button onclick="subscribeChat()">ì±„íŒ… êµ¬ë…(ì˜µì…˜)</button>
</div>

<h3>Logs</h3>
<pre id="log"></pre>

<script>
  let stompClient = null;
  let sock = null;

  function log(msg) {
    const el = document.getElementById("log");
    el.textContent += msg + "\n";
    el.scrollTop = el.scrollHeight;
    console.log(msg);
  }

  function clearLog() {
    document.getElementById("log").textContent = "";
  }

  function setToken(v) {
    document.getElementById("token").value = v;
  }

  function connect() {
    const endpoint = document.getElementById("endpoint").value;
    const token = document.getElementById("token").value.trim();

    log("------------------------------------------------------------");
    log(`â–¶ CONNECT TRY endpoint=${endpoint}`);
    log(`â–¶ tokenProvided=${token ? "YES" : "NO"}`);

    sock = new SockJS(endpoint);
    stompClient = Stomp.over(sock);

    // stomp ë‚´ë¶€ debug ë¡œê·¸(ì›í•˜ë©´ ë„ê¸°)
    stompClient.debug = (str) => log("[stomp] " + str);

    // âœ… í•µì‹¬: ì„œë²„ê°€ STOMP ERROR í”„ë ˆì„ì„ ë³´ë‚´ë©´ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜¨ë‹¤.
    stompClient.onerror = (frame) => {
      log("ğŸš¨ [STOMP ERROR FRAME RECEIVED]");
      try {
        log("headers=" + JSON.stringify(frame.headers));
      } catch (e) {}

      // frame.bodyì— ìš°ë¦¬ê°€ ë§Œë“  JSON(WsErrorEvent)ì´ ë“¤ì–´ì˜¨ë‹¤.
      if (frame.body) {
        log("body(raw)=" + frame.body);
        try {
          const obj = JSON.parse(frame.body);
          log(`body(parsed)=code=${obj.code}, message=${obj.message}, timestamp=${obj.timestamp}`);
        } catch (e) {
          log("body(parse fail)=" + e.message);
        }
      } else {
        log("body=<empty>");
      }
    };

    // WebSocket close í™•ì¸ (SockJSì—¬ë„ close ì´ë²¤íŠ¸ëŠ” ë°œìƒ)
    sock.onclose = (e) => {
      log(`ğŸ”Œ [SOCKJS CLOSED] code=${e?.code}, reason=${e?.reason}`);
    };

    const headers = {};
    if (token) headers["Authorization"] = token.startsWith("Bearer ") ? token : ("Bearer " + token);

    stompClient.connect(headers, (frame) => {
      log("âœ… CONNECTED OK");
      log(String(frame));

      // ì—°ê²° ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì•„ë˜ëŠ” ì˜ë¯¸ê°€ ìˆìŒ
      // (CONNECT ì‹¤íŒ¨ë©´ ì—¬ê¸°ë¡œ ëª» ë“¤ì–´ì˜´)
      log("âœ… TIP: ì´ì œ êµ¬ë…/ì „ì†¡ í…ŒìŠ¤íŠ¸ë„ ê°€ëŠ¥");
    }, (err) => {
      // connect error callbackì€ ë¼ì´ë¸ŒëŸ¬ë¦¬/í™˜ê²½ì— ë”°ë¼ ë©”ì‹œì§€ê°€ ë­‰ëš±ê·¸ë ¤ì§ˆ ìˆ˜ ìˆìŒ
      log("âŒ CONNECT ERROR CALLBACK");
      try {
        log("err=" + JSON.stringify(err));
      } catch (e) {
        log("err=" + String(err));
      }
      log("â— CONNECT ì‹¤íŒ¨ ìƒì„¸ëŠ” ìœ„ì˜ [STOMP ERROR FRAME RECEIVED] ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    });
  }

  function disconnect() {
    if (stompClient) {
      stompClient.disconnect(() => log("ğŸ‘‹ DISCONNECTED"));
    }
    stompClient = null;
    sock = null;
  }

  // ì—°ê²° ì„±ê³µ í›„ì—ë§Œ(ì˜µì…˜) ì±„íŒ… êµ¬ë… ë¶™ì—¬ë³´ê¸°
  function subscribeChat() {
    if (!stompClient) return alert("ë¨¼ì € Connect í•˜ì„¸ìš”");
    const roomId = document.getElementById("roomId").value.trim();
    if (!roomId) return alert("roomIdë¥¼ ì…ë ¥í•˜ì„¸ìš”");

    log(`ğŸ“Œ subscribe /topic/chat.rooms.${roomId}`);
    stompClient.subscribe(`/topic/chat.rooms.${roomId}`, (message) => {
      log("ğŸ“© [ROOM TOPIC] " + message.body);
    });

    log("ğŸ“Œ subscribe /user/queue/chat.rooms");
    stompClient.subscribe(`/user/queue/chat.rooms`, (message) => {
      log("ğŸ§¾ [MY ROOMS QUEUE] " + message.body);
    });

    log("ğŸ“Œ subscribe /user/queue/errors");
    stompClient.subscribe(`/user/queue/errors`, (message) => {
      log("ğŸš¨ [WS QUEUE ERROR] " + message.body);
    });

    log("âœ… SUBSCRIBED");
  }
</script>
</body>
</html>
