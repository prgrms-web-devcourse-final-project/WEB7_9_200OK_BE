<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”¥ ê²½ë§¤ ì´ëª¨ì§€ í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    input, button, select { padding: 8px; margin: 4px; }
    .row { margin: 10px 0; }
    #messages, #errors { background: #111; color: #0f0; padding: 12px; min-height: 140px; white-space: pre-wrap; }
    #errors { color: #ff5; }
  </style>
</head>
<body>
<h2>ğŸ”¥ ê²½ë§¤ ì´ëª¨ì§€(WebSocket) í…ŒìŠ¤íŠ¸</h2>

<div class="row">
  <label>endpoint:</label>
  <select id="endpoint">
    <option value="http://localhost:8080/ws-stomp">/ws-stomp (SECURED, í† í° í•„ìˆ˜)</option>
    <option value="http://localhost:8080/ws-stomp-public">/ws-stomp-public (PUBLIC, í† í° ì„ íƒ)</option>
  </select>
</div>

<div class="row">
  <label>auctionId:</label>
  <input id="auctionId" value="1" style="width: 100px;" />

  <label>accessToken(ì„ íƒ):</label>
  <input id="token" style="width: 520px;" placeholder="Bearer ì—†ì´ í† í°ë§Œ ë„£ì–´ë„ ë¨" />

  <button onclick="connect()">1) ì—°ê²°í•˜ê¸°</button>
  <button onclick="disconnect()">ì—°ê²° ëŠê¸°</button>
</div>

<div class="row">
  <button onclick="sendEmoji('FIRE')">2) ğŸ”¥ ë¶ˆê½ƒ ì˜ê¸°</button>
  <button onclick="sendEmoji('LIKE')">3) ğŸ‘ ì¢‹ì•„ìš” ì˜ê¸°</button>
</div>

<hr/>

<h3>ğŸ“© ë°›ì€ ë©”ì‹œì§€ (/topic/auction/{id})</h3>
<div id="messages"></div>

<h3>âš ï¸ ì—ëŸ¬ (/user/queue/errors) - ë¡œê·¸ì¸ì¼ ë•Œë§Œ ìˆ˜ì‹  ê°€ëŠ¥</h3>
<div id="errors"></div>

<script>
  let stompClient = null;

  function append(id, msg) {
    const el = document.getElementById(id);
    el.textContent += msg + "\n";
  }

  function connect() {
    const endpoint = document.getElementById("endpoint").value;
    const auctionId = document.getElementById("auctionId").value.trim();
    const token = document.getElementById("token").value.trim();

    if (!auctionId) {
      alert("auctionIdë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }

    const socket = new SockJS(endpoint);
    stompClient = Stomp.over(socket);

    // ë””ë²„ê·¸ ë¡œê·¸ ë³´ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ
    // stompClient.debug = (str) => append("messages", "[stomp] " + str);

    const headers = {};
    if (token) {
      headers["Authorization"] = token.startsWith("Bearer ") ? token : ("Bearer " + token);
    }

    stompClient.connect(headers, function(frame) {
      alert("ì—°ê²° ì„±ê³µ!");
      append("messages", "âœ… CONNECTED: " + frame);

      // 1) ê²½ë§¤ í† í”½ êµ¬ë… (ë¹„ë¡œê·¸ì¸ë„ ê°€ëŠ¥í•˜ê²Œ ì„¤ê³„ë˜ì–´ ìˆìŒ)
      stompClient.subscribe(`/topic/auction/${auctionId}`, function(message) {
        const body = message.body;
        append("messages", "ğŸ“© " + body);
      });

      // 2) ì—ëŸ¬ êµ¬ë… (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ê°€ëŠ¥: /user/** êµ¬ë…ì€ ì¸ì¦ í•„ìš”)
      stompClient.subscribe(`/user/queue/errors`, function(message) {
        append("errors", "âŒ " + message.body);
      });

      append("messages", `âœ… SUBSCRIBED: /topic/auction/${auctionId}`);
      append("messages", `âœ… SUBSCRIBED: /user/queue/errors (ë¡œê·¸ì¸ ì‹œ)`);
    }, function(err) {
      append("errors", "âŒ CONNECT ERROR: " + JSON.stringify(err));
      alert("ì—°ê²° ì‹¤íŒ¨ - ì½˜ì†”/ì—ëŸ¬ì°½ í™•ì¸");
    });
  }

  function disconnect() {
    if (stompClient) {
      stompClient.disconnect(() => append("messages", "ğŸ‘‹ DISCONNECTED"));
    }
    stompClient = null;
  }

  function sendEmoji(type) {
    if (!stompClient) return alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”");
    const auctionId = document.getElementById("auctionId").value.trim();
    if (!auctionId) return alert("auctionIdë¥¼ ì…ë ¥í•˜ì„¸ìš”");

    const payload = JSON.stringify({ emojiType: type });

    // âœ… ì„œë²„ @MessageMapping("/auctions/{auctionId}/emoji") ì´ë¯€ë¡œ:
    // SEND destination = /app/auctions/{auctionId}/emoji
    stompClient.send(`/app/auctions/${auctionId}/emoji`, {}, payload);
    append("messages", `â¡ï¸ SEND: ${payload}`);
  }
</script>
</body>
</html>
